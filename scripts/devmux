#!/usr/bin/env bash
# devmux — interactive SSH + tmux launcher.
# Connects to a remote host, picks a project, tool, and tmux mode.
set -euo pipefail

# ── Locate repo and source libraries ─────────────────────────────
resolve_path() {
    local path="$1"
    local resolved=""

    if command -v realpath >/dev/null 2>&1; then
        resolved=$(realpath "$path" 2>/dev/null || true)
        if [[ -n "$resolved" ]]; then
            echo "$resolved"
            return 0
        fi
    fi

    if command -v readlink >/dev/null 2>&1; then
        resolved=$(readlink -f "$path" 2>/dev/null || true)
        if [[ -n "$resolved" ]]; then
            echo "$resolved"
            return 0
        fi
    fi

    local target="$path"
    if command -v readlink >/dev/null 2>&1; then
        while [[ -L "$target" ]]; do
            local link
            link=$(readlink "$target")
            if [[ "$link" = /* ]]; then
                target="$link"
            else
                local dir
                dir=$(cd "$(dirname "$target")" && pwd -P)
                target="$dir/$link"
            fi
        done
    fi

    local dir
    dir=$(cd "$(dirname "$target")" && pwd -P)
    echo "$dir/$(basename "$target")"
}

SCRIPT_PATH="$(resolve_path "$0")"
REPO_DIR="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd -P)"

if [[ -d "$REPO_DIR/lib" ]]; then
    source "$REPO_DIR/lib/common.sh"
else
    # Fallback if running outside repo (shouldn't happen with symlink install)
    die() { echo "Error: $*" >&2; exit 1; }
    die "Cannot find lib/ directory. Is the devmux repo intact?"
fi

# ── Config ─────────────────────────────────────────────────────────
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/devmux"
CONFIG_FILE="$CONFIG_DIR/devmux.conf"
REMOTE_SCRIPT="${REMOTE_SCRIPT:-devmux-remote}"
SSH_OPTS="${SSH_OPTS:-}"

# ── Local host detection (avoid SSH-to-self) ─────────────────────
detect_self_tailscale_ip() {
    local repo_dir="$1"
    local self_name="" self_ts_ip=""

    if [[ -f "$repo_dir/lib/platform.sh" && -f "$repo_dir/machines.conf" ]]; then
        # shellcheck source=/dev/null
        source "$repo_dir/lib/platform.sh"
        # shellcheck source=/dev/null
        source "$repo_dir/machines.conf"

        self_name="$(detect_hostname)"
        if declare -p MACHINES >/dev/null 2>&1; then
            local machine var_prefix ts_ip_var
            for machine in "${MACHINES[@]}"; do
                if [[ "$machine" == "$self_name" ]]; then
                    var_prefix="MACHINE_${machine//-/_}"
                    ts_ip_var="${var_prefix}_TAILSCALE_IP"
                    self_ts_ip="${!ts_ip_var:-}"
                    break
                fi
            done
        fi
    fi

    echo "$self_ts_ip"
}

ssh_config_hostname() {
    local target="$1"
    local line
    while IFS= read -r line; do
        case "$line" in
            hostname\ *) echo "${line#hostname }"; return 0 ;;
        esac
    done < <(ssh -G "$target" 2>/dev/null || true)
    return 1
}

should_run_local() {
    local ssh_target="$1"
    local self_ts_ip="$2"

    case "$ssh_target" in
        ""|local|localhost|127.0.0.1|::1) return 0 ;;
    esac

    if [[ -n "$self_ts_ip" ]]; then
        local host_name
        host_name="$(ssh_config_hostname "$ssh_target" || true)"
        if [[ -n "$host_name" && "$host_name" == "$self_ts_ip" ]]; then
            return 0
        fi
    fi

    return 1
}

local_remote_script() {
    local remote_script="$1"
    local repo_dir="$2"

    if command -v "$remote_script" >/dev/null 2>&1; then
        echo "$remote_script"
        return 0
    fi
    if [[ -x "$repo_dir/scripts/devmux-remote" ]]; then
        echo "$repo_dir/scripts/devmux-remote"
        return 0
    fi

    return 1
}

# ── Defaults (overridden by config) ───────────────────────────────
HOSTS=()
TOOLS=("shell")
TOOL_shell_CMD=""

# ── Usage ──────────────────────────────────────────────────────────
usage() {
    cat <<'EOF'
Usage: devmux [OPTIONS]

Interactive menu to SSH into a host, pick a project, tool, and tmux session.

Options:
  --host <name>       Skip host picker
  --project <name>    Skip project picker
  --tool <name>       Skip tool picker
  --mode <resume|new> Skip mode picker
  -h, --help          Show this help

Config: ~/.config/devmux/devmux.conf
EOF
}

# ── Early --help check (before config) ────────────────────────────
for arg in "$@"; do
    case "$arg" in
        -h|--help) usage; exit 0 ;;
    esac
done

# ── Load config ───────────────────────────────────────────────────
if [[ ! -f "$CONFIG_FILE" ]]; then
    die "Config not found: $CONFIG_FILE
Run setup.sh or copy config/devmux.example.conf there."
fi

# shellcheck source=/dev/null
source "$CONFIG_FILE"

# ── Parse CLI overrides ───────────────────────────────────────────
ARG_HOST="" ARG_PROJECT="" ARG_TOOL="" ARG_MODE=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --host)    ARG_HOST="$2"; shift 2 ;;
        --project) ARG_PROJECT="$2"; shift 2 ;;
        --tool)    ARG_TOOL="$2"; shift 2 ;;
        --mode)    ARG_MODE="$2"; shift 2 ;;
        -h|--help) usage; exit 0 ;;
        *)         die "Unknown option: $1" ;;
    esac
done

# ── Step 1: Choose host ───────────────────────────────────────────
if [[ ${#HOSTS[@]} -eq 0 ]]; then
    die "No HOSTS defined in config."
fi

if [[ -n "$ARG_HOST" ]]; then
    HOST="$ARG_HOST"
else
    HOST=$(pick "Host:" "${HOSTS[@]}")
fi

SSH_TARGET=$(get_var "HOST_${HOST//-/_}_SSH")
WSL_PREFIX=$(get_var "HOST_${HOST//-/_}_WSL_PREFIX")
PROJECTS_DIR=$(get_var "HOST_${HOST//-/_}_PROJECTS_DIR")
PROJECTS_DIR="${PROJECTS_DIR:-\$HOME/projects}"

if [[ -z "$SSH_TARGET" ]]; then
    die "HOST_${HOST//-/_}_SSH not set in config."
fi

# If the chosen host resolves to this machine, run locally to avoid SSH-to-self.
SELF_TS_IP="$(detect_self_tailscale_ip "$REPO_DIR")"
LOCAL_MODE=false
if should_run_local "$SSH_TARGET" "$SELF_TS_IP"; then
    LOCAL_MODE=true
fi

# ── Step 2: Fetch remote project list ─────────────────────────────
REMOTE_LS_CMD="ls -1 ${PROJECTS_DIR} 2>/dev/null || true"
if $LOCAL_MODE; then
    PROJECT_LIST=""
    PROJECT_LIST=$(spin "Loading projects (local)..." bash -lc "$REMOTE_LS_CMD" 2>/dev/null) || \
        die "Could not list projects locally. Check that your projects directory exists."
else
    if [[ -n "$WSL_PREFIX" ]]; then
        remote_ls_escaped="${REMOTE_LS_CMD//\"/\\\"}"
        REMOTE_CMD="$WSL_PREFIX \"${remote_ls_escaped}\""
    else
        REMOTE_CMD="$REMOTE_LS_CMD"
    fi

    PROJECT_LIST=""
    # shellcheck disable=SC2086
    PROJECT_LIST=$(spin "Connecting to $HOST ($SSH_TARGET)..." \
        ssh $SSH_OPTS -o ConnectTimeout=10 "$SSH_TARGET" "$REMOTE_CMD" 2>/dev/null) || \
        die "Could not connect to $SSH_TARGET. Check SSH config and connectivity."
fi

if [[ -z "$PROJECT_LIST" ]]; then
    die "No projects found on $HOST under $PROJECTS_DIR."
fi

mapfile -t PROJECTS <<< "$PROJECT_LIST"

if [[ -n "$ARG_PROJECT" ]]; then
    PROJECT="$ARG_PROJECT"
else
    PROJECT=$(pick "Project:" "${PROJECTS[@]}")
fi

# ── Step 3: Choose tool ──────────────────────────────────────────
if [[ ${#TOOLS[@]} -eq 0 ]]; then
    die "No TOOLS defined in config."
fi

if [[ -n "$ARG_TOOL" ]]; then
    TOOL="$ARG_TOOL"
else
    TOOL=$(pick "Tool:" "${TOOLS[@]}")
fi

TOOL_CMD=$(get_var "TOOL_${TOOL}_CMD")

# ── Step 4: Choose mode ──────────────────────────────────────────
if [[ -n "$ARG_MODE" ]]; then
    MODE="$ARG_MODE"
else
    MODE=$(pick "Mode:" "resume" "new")
fi

# ── Step 5: Connect ──────────────────────────────────────────────
REMOTE_ARGS="--project $(printf '%q' "$PROJECT") --tool $(printf '%q' "$TOOL") --mode $(printf '%q' "$MODE")"
if [[ -n "$TOOL_CMD" ]]; then
    REMOTE_ARGS="$REMOTE_ARGS --tool-cmd $(printf '%q' "$TOOL_CMD")"
fi

REMOTE_EXEC="$REMOTE_SCRIPT $REMOTE_ARGS"
if $LOCAL_MODE; then
    LOCAL_REMOTE_SCRIPT="$(local_remote_script "$REMOTE_SCRIPT" "$REPO_DIR")" || \
        die "Local run requested but devmux-remote not found. Run setup.sh on this host."
else
    if [[ -n "$WSL_PREFIX" ]]; then
        # Windows uses cmd-style quoting; wrap the bash command in double quotes.
        remote_exec_escaped="${REMOTE_EXEC//\"/\\\"}"
        FULL_CMD="$WSL_PREFIX \"${remote_exec_escaped}\""
    else
        FULL_CMD="$REMOTE_EXEC"
    fi
fi

header "→ $HOST / $PROJECT / $TOOL ($MODE)"
if $LOCAL_MODE; then
    exec "$LOCAL_REMOTE_SCRIPT" $REMOTE_ARGS
else
    # shellcheck disable=SC2086
    exec ssh $SSH_OPTS -t "$SSH_TARGET" "$FULL_CMD"
fi
