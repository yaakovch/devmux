# devmux

Interactive SSH + tmux launcher. Pick a host, project, and tool from a menu — land in the right tmux session instantly.

Built for developers who work across multiple machines (home PC, work PC) and connect from laptops, phones (Termux), or other devices over Tailscale/SSH.

## How it works

```
[Client]                          [Host (Windows+WSL or Linux)]
devmux                            devmux-remote
  ├─ pick host ──── SSH ────────→   ├─ cd ~/projects/<project>
  ├─ pick project (fetched live)    ├─ tmux new/attach session
  ├─ pick tool (codex/claude/…)     └─ run tool inside tmux
  └─ pick resume/new
```

- **Client** runs on any machine you SSH *from* (laptop, phone, another PC).
- **Host** is the machine you SSH *into* (your dev PCs running WSL or Linux).

## Setup

### New machine (Linux/WSL/Termux)

```bash
git clone <repo-url> ~/devmux
cd ~/devmux
bash setup.sh
```

`setup.sh` auto-detects your platform, identifies the machine, and:
- **Host**: installs tmux, symlinks `devmux-remote`, creates `~/projects/`
- **Client**: symlinks `devmux`, generates `~/.ssh/config` and `devmux.conf` from `machines.conf`
- **SSH keys**: generates if missing, offers to distribute to other machines

Updating is just `git pull` — scripts are symlinked, not copied.

To regenerate `~/.config/devmux/devmux.conf` from `machines.conf`:

```bash
bash setup.sh --regen-config
```

### Windows host (admin PowerShell)

```powershell
# Run in an ADMIN PowerShell
.\setup.ps1
```

Handles OpenSSH Server, `administrators_authorized_keys` (UTF-8 no BOM, permissions), SSH config, and optionally runs `setup.sh` in WSL.

To add a key from another machine (no password SSH needed), pass it explicitly:

```powershell
.\setup.ps1 -AddKey "ssh-ed25519 AAAA... comment"
```

Optional convenience: `setup.ps1` also installs a Windows `devmux` command (`devmux.cmd`) that runs `devmux` inside WSL, so you can type `devmux` from any folder in PowerShell/cmd.

If your WSL distro isn't `Ubuntu`, either run:

```powershell
.\setup.ps1 -WslDistro Ubuntu-22.04
```

Or set an override for the shim:

```powershell
setx DEVMUX_WSL_DISTRO Ubuntu-22.04
```

### Android (Termux)

```bash
pkg install openssh gum   # or fzf — both optional
git clone <repo-url> ~/devmux
cd ~/devmux
bash setup.sh
```

For one-tap launch: install **Termux:Widget** from F-Droid. `setup.sh` creates the `~/.shortcuts/devmux` symlink automatically.

### Adding a new machine

1. Edit `machines.conf` — add the machine's Tailscale IP, username, OS type
2. Re-run `setup.sh` on existing clients to regenerate SSH config
3. On the new machine: clone + `setup.sh` (or `setup.ps1` on Windows)

## Usage

```bash
devmux
```

Or skip menus with flags:

```bash
devmux --host work-m --project myapp --tool claude --mode resume
```

## Configuration

### machines.conf (network topology)

Lives in the repo. Defines all machines, IPs, usernames, and roles:

```bash
MACHINES=("gaming-desktop" "work-m")

MACHINE_gaming_desktop_TAILSCALE_IP="100.83.144.22"
MACHINE_gaming_desktop_WIN_USER="yaako"
MACHINE_gaming_desktop_WSL_USER="sapir_cz"
MACHINE_gaming_desktop_OS="windows-wsl"
MACHINE_gaming_desktop_ROLES=("host")
```

### devmux.conf (runtime config)

Lives at `~/.config/devmux/devmux.conf`. Generated by `setup.sh`, or edit manually. See `config/devmux.example.conf` for all options.

```bash
HOSTS=("gaming-desktop" "work-m")
HOST_gaming_desktop_SSH="gaming-desktop"
# Special value: "local" runs devmux-remote locally (no SSH)
# HOST_gaming_desktop_SSH="local"
# If SSH lands on Windows, use a WSL prefix to enter the right distro (and user).
# Example: wsl -d Ubuntu -u sapir_cz --exec bash -lc
HOST_gaming_desktop_WSL_PREFIX="wsl -d Ubuntu --exec bash -lc"

TOOLS=("codex" "claude" "shell")
TOOL_codex_CMD="codex"
TOOL_claude_CMD="claude"
TOOL_shell_CMD=""
```

### SSH config

`setup.sh` generates `~/.ssh/config` entries inside a managed block:

```
# BEGIN devmux-managed
Host gaming-desktop
    HostName 100.83.144.22
    User yaako
# END devmux-managed
```

Your own entries outside this block are preserved.

## Session naming

Sessions follow the pattern `<tool>:<project>` for resume mode, and `<tool>:<project>:<timestamp>` for new mode:

```
claude:myapp              ← resumed
codex:backend:1706123456  ← new session
```

## File structure

```
devmux/
├── setup.sh                # Bootstrap for Linux/WSL/Termux
├── setup.ps1               # Bootstrap for Windows (admin)
├── machines.conf           # Network topology (source of truth)
├── lib/
│   ├── common.sh           # die(), info(), pick(), confirm(), header(), spin(), input()
│   ├── platform.sh         # detect_platform(), detect_hostname()
│   ├── ssh.sh              # Key gen, distribution, config generation
│   └── tailscale.sh        # Tailscale detection, identification
├── scripts/
│   ├── devmux              # Client launcher
│   └── devmux-remote       # Host session manager
├── config/
│   └── devmux.example.conf # Example runtime config
├── termux/
│   └── shortcuts/devmux    # Termux:Widget shortcut
└── README.md
```

## Requirements

- **Client**: bash, ssh, optional [gum](https://github.com/charmbracelet/gum) (preferred) or fzf
- **Host**: bash, tmux, ssh server
- **Connectivity**: Tailscale (recommended) or any SSH-reachable network

## Troubleshooting

**"Config not found"** — Run `setup.sh` or copy `config/devmux.example.conf` to `~/.config/devmux/devmux.conf`.

**"Could not connect"** — Check that `ssh <host-alias>` works manually. Verify Tailscale is up.

**"No projects found"** — Ensure `~/projects/` exists on the host and has subdirectories.

**"devmux-remote: command not found"** — Run `setup.sh` on the host, or check that `~/.local/bin` is in PATH.

**Windows SSH key issues** — Run `setup.ps1` as admin. Keys must be in `C:\ProgramData\ssh\administrators_authorized_keys` (UTF-8, no BOM) for admin users.
